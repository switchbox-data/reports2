---
title: Analysis - ny_aeba_grid
toc: true
reference-location: margin
fig-cap-location: bottom

appendix-style: default
citation-location: document
citation:
  container-title: Switchbox

format:
  html:
    page-layout: full
---


```{r}
#| label: setup
library(tidyverse)
library(scales)
library(gt)
library(gtExtras)
library(arrow)

source("/workspaces/reports2/lib/ggplot/switchbox_theme.R")
```


```{r}

# Read processed NYISO hourly load data from S3
# Set up S3 filesystem with arrow
s3_bucket <- arrow::s3_bucket(
    bucket = "data.sb",
    region = "us-west-2"
)

s3_file_path <- "ny_aeba_grid/nyiso/hourly/nyiso_hourly_load.parquet"

nyiso_hourly_load <- tryCatch(
    {
        arrow::read_parquet(s3_bucket$path(s3_file_path))
    },
    error = function(e) {
        cat("\n")
        cat("ERROR: Could not read processed NYISO hourly load data from S3.\n")
        cat("Bucket: data.sb\n")
        cat("Path:", s3_file_path, "\n")
        cat("Error details:", conditionMessage(e), "\n\n")
        cat("The processed parquet file may not exist yet, or there may be an AWS credentials issue.\n")
        cat("Please run the data processing script first:\n")
        cat("  Rscript reports/ny_aeba_grid/utils/make_hourly_nyiso_load.R\n\n")
        stop("Missing required data file on S3", call. = FALSE)
    }
)

# add a "NY_STATE" zone, which is the sum of all zones
nyiso_monthly_peak_load <- nyiso_hourly_load |>
    pivot_wider(
        names_from = zone,
        values_from = load,
        values_fn = first
    ) |>
    mutate(
        NY_STATE = rowSums(pick(-c(year, month, day, hour)), na.rm = TRUE)
    ) |>
    pivot_longer(
        cols = -c(year, month, day, hour),
        names_to = "zone",
        values_to = "load"
    ) |>
    filter(zone == "NY_STATE") |>
    # take the maximum hour for each year + month combo
    group_by(year, month) |>
    summarize(load = max(load), .groups = "drop") |>
    ungroup()

View(nyiso_hourly_load |> head(20))
# Aggregate total NYISO load by date and hour (summing across all zones)
# nyiso_hourly_load <- nyiso_hourly_load |>
#     group_by(date, hour) |>
#     summarize(total_load = sum(load, na.rm = TRUE), .groups = "drop")

```

```{r}
winter_months <- c(11, 12, 1, 2)
summer_months <- c(6, 7, 8, 9)
shoulder_months <- c(3, 4, 5, 10)

library(ggplot2)
library(dplyr)
library(lubridate)

# First, we need a datetime column for plotting
# We'll assume nyiso_monthly_peak_load has year and month columns
nyiso_monthly_peak_load <- nyiso_monthly_peak_load |>
    mutate(
        # Set the datetime to the first of each month
        datetime = as.Date(paste(year, month, "01", sep = "-"))
    ) |>
    mutate(
        season = case_when(
            month %in% winter_months ~ "Winter",
            month %in% summer_months ~ "Summer",
            month %in% shoulder_months ~ "Shoulder",
            TRUE ~ "Other"
        )
    ) |>
    # flag the winter peaks
    mutate(
        winter_of = case_when(
            month %in% c(11, 12) ~ paste0("Winter ", year, "-", year + 1),
            month %in% c(1, 2) ~ paste0("Winter ", year - 1, "-", year),
            TRUE ~ as.character(year) # Convert year to character for consistency
        )
    )

write_csv(
    nyiso_monthly_peak_load,
    "/workspaces/reports2/reports/ny_aeba_grid/cache/nyiso_monthly_peak_load.csv"
)


winter_peaks <- nyiso_monthly_peak_load |>
    filter(season == "Winter") |>
    group_by(winter_of) |>
    filter(load == max(load)) |>
    ungroup()

write_csv(
    winter_peaks,
    "/workspaces/reports2/reports/ny_aeba_grid/cache/nyiso_winter_peaks.csv"
)

summer_peaks <- nyiso_monthly_peak_load |>
    filter(season == "Summer") |>
    group_by(year) |>
    filter(load == max(load)) |>
    ungroup()

write_csv(
    summer_peaks,
    "/workspaces/reports2/reports/ny_aeba_grid/cache/nyiso_summer_peaks.csv"
)

# Filter only months in winter, summer, or shoulder for plotting
nyiso_plot_df <- nyiso_monthly_peak_load |>
    filter(season %in% c("Winter", "Summer", "Shoulder"))

# Add blue dots at each winter peak
monthly_peak_load_plot <- ggplot(nyiso_plot_df, aes(x = datetime, y = load)) +
    # monthly load in black
    geom_line(size = 1.1) +
    # -- Winter ---
    # Add blue dots for the winter peaks
    geom_point(
        data = winter_peaks,
        aes(x = datetime, y = load),
        color = "blue",
        size = 3
    ) +
    geom_text(
        data = winter_peaks,
        aes(
            x = datetime,
            y = load,
            label = paste0(
                format(datetime, "%b %Y"),
                "\n",
                format(round(load, 0), big.mark = ","),
                " MW"
            )
        ),
        color = "blue",
        vjust = -1,
        size = 3
    ) +
    # -- Summer ---
    # Add red dots for the summer peaks
    geom_point(
        data = summer_peaks,
        aes(x = datetime, y = load),
        color = "red",
        size = 3
    ) +
    geom_text(
        data = summer_peaks,
        aes(
            x = datetime,
            y = load,
            label = paste0(
                format(datetime, "%b %Y"),
                "\n",
                format(round(load, 0), big.mark = ","),
                " MW"
            )
        ),
        color = "red",
        vjust = -1,
        size = 3
    ) +
    # -- winter capacity -- dashed line at 40592 MW
    geom_hline(
        yintercept = 39971,
        linetype = "dashed",
        color = "black",
        size = 0.8
    ) +
    annotate(
        "text",
        x = as.POSIXct("2024-01-01", tz = "America/New_York"),
        y = 40592 + 1200,
        label = "Winter Capability (2025 Gold Book)",
        color = "black",
        size = 4,
        fontface = "bold"
    ) +
    labs(
        title = "NYISO Monthly Peak Load by Season",
        x = "Time",
        y = "Monthly Peak Load (MW)",
        color = "Season"
    ) +
    ylim(0, 42000)


# save the plot to a file
ggsave(
    "/workspaces/reports2/reports/ny_aeba_grid/cache/monthly_peak_load_plot.png",
    monthly_peak_load_plot,
    width = 10,
    height = 6
)
ggsave(
    "/workspaces/reports2/reports/ny_aeba_grid/cache/monthly_peak_load_plot.svg",
    monthly_peak_load_plot,
    width = 10,
    height = 6
)


monthly_peak_load_plot

```
