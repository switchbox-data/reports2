name: Main

on:
  push:
    branches: [ main ]
  pull_request:
    types: [ opened, synchronize, reopened, ready_for_review ]

# This workflow uses a 3-job structure to optimize CI performance:
#
# 1. build-devcontainer-image: Builds ONLY the devcontainer image (base environment, no deps) and pushes to registry, for use by subsequent jobs, and to speed up Devpod.
# 2. quality-checks & tests: Pulls the prebuilt devcontainer image, run in PARALLEL, installing fresh deps each time, to avoid stale dependencies.

jobs:
  build-devcontainer-image:
    # Builds and publishes the devcontainer image using DevPod CLI (required for devpod up compatibility).
    # DevPod build creates images with hash-based tags, which we also tag as 'latest' for use by CI jobs.
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write  # Needed to push image to ghcr.io
    steps:
      - uses: actions/checkout@v5

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Install DevPod CLI
        run: |
          curl -L -o devpod "https://github.com/loft-sh/devpod/releases/latest/download/devpod-linux-amd64"
          chmod +x devpod
          sudo mv devpod /usr/local/bin/

      - name: Initialize Docker provider
        run: devpod provider add docker

      - name: Build and push devcontainer image with DevPod
        run: |
          # DevPod will build (or reuse) the image and tag it with:
          # 1. A hash-based tag (e.g. devpod-d95c1f5a, automatically), for use with DevPod up.
          # 2. The 'latest' tag (via --tag flag), for use by downstream jobs.
          devpod build . \
            --provider docker \
            --repository ghcr.io/switchbox-data/reports2 \
            --platform linux/amd64 \
            --tag latest

  quality-checks:
    # Waits for build-devcontainer-image to complete, then runs quality checks in parallel with tests.
    # Pulls prebuilt base image, installs deps fresh, to avoid stale dependencies.
    needs: build-devcontainer-image
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read  # Only need read access to pull image
    steps:
      - uses: actions/checkout@v5

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Run quality checks
        uses: devcontainers/ci@v0.3
        with:
          imageName: ghcr.io/switchbox-data/reports2
          # cacheFrom: Pull the image build-devcontainer-image just pushed
          cacheFrom: ghcr.io/switchbox-data/reports2:latest
          # push: never = Don't push, just use the image. It's build-devcontainer-image's job to push the image.
          push: never
          # postCreateCommand runs automatically before this (installs deps fresh)
          runCmd: just check

  tests:
    # Runs in parallel with quality-checks. Pulls prebuilt base image, installs deps fresh, to avoid stale dependencies.
    needs: build-devcontainer-image
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read  # Only need read access to pull image
    steps:
      - uses: actions/checkout@v5

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Run tests
        uses: devcontainers/ci@v0.3
        with:
          imageName: ghcr.io/switchbox-data/reports2
          # cacheFrom: Pull the image build-devcontainer-image just pushed
          cacheFrom: ghcr.io/switchbox-data/reports2:latest
          # push: never = Don't push, just use the image. It's build-devcontainer-image's job to push the image.
          push: never
          # postCreateCommand runs automatically before this (installs deps fresh)
          runCmd: just test
