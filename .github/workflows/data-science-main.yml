name: Main

on:
  push:
    branches: [ main ]
  pull_request:
    types: [ opened, synchronize, reopened, ready_for_review ]

# This workflow uses a 3-job structure to optimize CI performance:
#
# 1. build-devcontainer-image: Builds ONLY the devcontainer image (base environment, no deps) and pushes to registry with :latest tag.
# 2. quality-checks & tests: Pull the prebuilt :latest image and run commands directly in it (no rebuild), running in PARALLEL.

jobs:
  build-devcontainer-image:
    # Builds and publishes the devcontainer image using DevPod CLI (required for devpod up compatibility).
    # DevPod build creates images with hash-based tags, which we also tag as 'latest' for use by CI jobs.
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write  # Needed to push image to ghcr.io
    steps:
      - uses: actions/checkout@v5

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # User skevetter's fork of DevPod CLI, which is actually maintained.
      - name: Install DevPod CLI
        run: |
          curl -L -o devpod "https://github.com/skevetter/devpod/releases/latest/download/devpod-linux-amd64"
          chmod +x devpod
          sudo mv devpod /usr/local/bin/

      - name: Initialize Docker provider
        run: devpod provider add docker

      - name: Configure DevPod to use GHCR as a build cache backend.
        run: |
          # This speeds up devcontainer image builds by reusing cached layers when possible.
          # Cached layers are stored at ghcr.io/switchbox-data/reports2.
          # Under the hood, DevPod automatically adds BuildKit cache flags:
          #   --cache-from type=registry,ref=ghcr.io/switchbox-data/reports2
          #   --cache-to type=registry,ref=ghcr.io/switchbox-data/reports2,mode=max

          devpod context set-options -o REGISTRY_CACHE=ghcr.io/switchbox-data/reports2

      - name: Build and push devcontainer image with DevPod
        run: |
          # TWO-TIER TAGGING STRATEGY:
          #
          # DevPod will build the image and tag it with:
          # 1. A hash-based tag (e.g. devpod-d95c1f5a), for use with `devpod up`. It does this automatically.
          # 2. The 'latest' tag, for use by downstream jobs. It does this via the --tag flag.
          #
          #
          # TWO-TIER CACHING STRATEGY:
          #
          # 1. DevPod Hash-Based Caching (Complete Skip):
          #    - DevPod calculates a hash from devcontainer.json (and Dockerfile if used)
          #    - If hash matches existing image in registry → skip build entirely (~30s)
          #    - Triggered when: No changes to devcontainer.json, features, or base image
          #
          # 2. BuildKit Registry Layer Caching (Incremental Build):
          #    - If devcontainer.json changes → `devpod build` actually preforms a rebuld
          #    - With REGISTRY_CACHE set above, BuildKit detects which layers to reuse from GHCR registry cache.
          #    - Layers BEFORE the change: Pulled from cache and reused (marked CACHED)
          #    - Layers STARTING WITH the change: Rebuilt from scratch
          #
          # Example: Adding a Python package in pyproject.toml
          #   - Base Ubuntu layer: CACHED ✓
          #   - Zsh, Just, Python, R, Quarto features: CACHED ✓
          #   - Python dependencies layer: REBUILT (only this changed)

          devpod build . \
            --provider docker \
            --repository ghcr.io/switchbox-data/reports2 \
            --platform linux/amd64 \
            --tag latest

  quality-checks:
    # Waits for build-devcontainer-image to complete, then runs quality checks in parallel with tests.
    # Pulls prebuilt base image, installs deps fresh, to avoid stale dependencies.
    needs: build-devcontainer-image
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read  # Only need read access to pull image
    steps:
      - uses: actions/checkout@v5

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Run quality checks
        uses: devcontainers/ci@v0.3
        with:
          imageName: ghcr.io/switchbox-data/reports2
          # cacheFrom: Pull the image build-devcontainer-image just pushed
          cacheFrom: ghcr.io/switchbox-data/reports2:latest
          # push: never = Don't push, just use the image. It's build-devcontainer-image's job to push the image.
          push: never
          # postCreateCommand runs automatically before this (installs deps fresh)
          runCmd: just check

  tests:
    # Runs in parallel with quality-checks. Pulls prebuilt base image, installs deps fresh, to avoid stale dependencies.
    needs: build-devcontainer-image
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read  # Only need read access to pull image
    steps:
      - uses: actions/checkout@v5

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Run tests
        uses: devcontainers/ci@v0.3
        with:
          imageName: ghcr.io/switchbox-data/reports2
          # cacheFrom: Pull the image build-devcontainer-image just pushed
          cacheFrom: ghcr.io/switchbox-data/reports2:latest
          # push: never = Don't push, just use the image. It's build-devcontainer-image's job to push the image.
          push: never
          # postCreateCommand runs automatically before this (installs deps fresh)
          runCmd: just test
